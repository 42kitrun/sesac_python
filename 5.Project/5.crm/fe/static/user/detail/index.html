<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <title>ì‚¬ìš©ì ì¡°íšŒ í˜ì´ì§€</title>
    <style>
        nav{
            text-align: center;
            background-color: bisque;
            padding: 2vh 0vw;
        }

        nav a{
            color: brown;
            font-size: 25px;
            text-decoration: none;
            margin: 1vh 1vw;
        }

        main {
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center; /* â† ì¤‘ìš”! */
        }
        
        #orderInfo > div:first-child {
            display: flex;
            justify-content: space-between; /* ğŸ‘ˆ í•µì‹¬ */
            align-items: center;
        }


        table {
            width: 100vw;
            border: 1px solid transparent;
            border-collapse: collapse;
            text-align: center;
        }

        #pageGroup {
            text-align: center;
            width: 100%;
            margin-top: 10px;
        }

        #pageGroup i {
            margin: 0 8px;
            cursor: pointer;
            font-size: 20px;
        }
        #pages span{
            margin: 0px 10px;
        }
        footer{
            width: 100vw;
            height: 10vh;
            background-color:blanchedalmond;
        }
    </style>
</head>
<body>
    <nav>
        <a href="/user">User</a>
        <a href="/store">Store</a>
        <a href="/item">Item</a>
        <a href="/order">Order</a>
        <a href="/orderitem">Order Item</a>
    </nav>
    <br/>
    <main>
        <div id="userInfo">
            <p>ê³ ê°ì •ë³´</p>
            <table>
                <tr>
                    <th><strong>íšŒì› ì •ë³´ë¥¼ ìš”ì²­í•˜ê³  ìˆìŠµë‹ˆë‹¤ ...</strong></th>
                </tr>
                <!--  íšŒì› ì¡°íšŒ -->
            </table>
        </div>
        <br/>
        <div id="orderInfo">
            <div>
                <span>ì£¼ë¬¸ì •ë³´</span>
                <select id ="listCount">
                    <option>ì „ì²´ë³´ê¸°</option>
                    <option>10ê°œì”© ë³´ê¸°</option>
                    <option>25ê°œì”© ë³´ê¸°</option>
                    <option>40ê°œì”© ë³´ê¸°</option>
                </select>
            </div>
            <table>
                <tr>
                    <th><strong>íšŒì›ë‹˜ì˜ ì£¼ë¬¸ ëª©ë¡ì„ ìš”ì²­í•˜ê³  ìˆìŠµë‹ˆë‹¤ ...</strong></th>
                </tr>
                <!--  ì£¼ë¬¸ ì¡°íšŒ -->
            </table>
            <br/>
            <div id="pageGroup">
                <i id = "firstPage" class="fa-duotone fa-solid fa-angles-left"></i>
                <i id = "previousPage" class="fa-solid fa-angle-left"></i>
                <span id = "pages"><!-- í˜ì´ì§€ í‘œì‹œ --></span>
                <i id = "nextPage" class="fa-solid fa-angle-right"></i>
                <i id = "lastPage" class="fa-duotone fa-solid fa-angles-right"></i>
            </div>
        </div>
        <br/>
        <div id="top5Stores">
            <p>ìì£¼ ë°©ë¬¸í•œ ë§¤ì¥ Top 5</p>
            <ol>
                <!-- <li>í• ë¦¬ìŠ¤ ê°•ì„œ3í˜¸ì  (1ë²ˆ ë°©ë¬¸)</li>-->
            </ol>
        </div>
    </main>
    <footer>
        ì—¬ê¸°ëŠ” footer
    </footer>

<script>
    const userInfoTable = document.querySelector('#userInfo>table');
    const orderInfoTable = document.querySelector('#orderInfo>table');

    const paging = document.getElementById('listCount');
    const pageGroup = document.getElementById('pageGroup');
    const pages = document.getElementById('pages');

    const url = 'http://localhost:7890';
    const pagesCount = 5; // í™”ë©´ì— ë³´ì´ê³  ì‹¶ì€ í˜ì´ì§€ ìˆ˜
    let lastPageNum = 1; // ì‘ë‹µì—ì„œ ë°”ë€œ

// ------------------------------------------------------------------------    

    document.addEventListener('DOMContentLoaded', ()=>{
        
        // URLì—ì„œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì½ì–´ì„œ í‘œì‹œ
        const params = new URLSearchParams(window.location.search);

        // ë¹ˆ ê°’ ì¿¼ë¦¬íŒŒë¼ë¯¸í„° ì œê±°
        for (const [key, value] of params.entries()) {
            if (!value || value.trim() == "" || value === undefined) {
                console.log(`ì‚­ì œë¨: ${key}`);
                params.delete(key);
            }
        }
        /* params.forEach(...)ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ìˆœíšŒ(iteration) ì¤‘ì´ê¸° ë•Œë¬¸ì—,
            ë°˜ë³µ ì¤‘ params.delete()ë¥¼ ì‚¬ìš©í•˜ë©´ ì»¬ë ‰ì…˜ì´ ë³€ê²½ë˜ì–´ ì œëŒ€ë¡œ ì‚­ì œê°€ ì•ˆ ë˜ëŠ” ê²½ìš°ê°€ ìˆìŠµë‹ˆë‹¤.
            ì´ê±´ JSì—ì„œ forEach() ë°˜ë³µ ì¤‘ ì»¬ë ‰ì…˜ì„ ìˆ˜ì •í•˜ëŠ” ì „í˜•ì ì¸ ì´ìŠˆì…ë‹ˆë‹¤.
            for...ofëŠ” ë‚´ë¶€ì ìœ¼ë¡œ params ê°ì²´ë¥¼ ë³µì‚¬í•œ ì´í„°ë ˆì´í„°ë¥¼ ì“°ê¸° ë•Œë¬¸ì— ë” ì•ˆì „í•˜ê²Œ ë™ì‘í•©ë‹ˆë‹¤
            */
   
        console.log( params.get('id'), params.get('listCount'),paging.value, params.get('page'));        
                   
        // select ë°•ìŠ¤
        if (!params.get('listCount')) {
            paging.value = 'ì „ì²´ë³´ê¸°';
            params.delete('listCount');
            params.delete('page');
            pageGroup.style.visibility = "hidden";
        } else {
            paging.value = `${params.get('listCount')}ê°œì”© ë³´ê¸°`;
        }

        // ì‚¼í•­ì—°ì‚°ì
        // document.getElementById('pages').textContent = params.get('page') ? params.get('page'):1;
        //  ? : ì‚¼í•­ ì—°ì‚°ìëŠ” falsy ê°’(0, '', null, undefined, false)ë„ ê±¸ëŸ¬ëƒ…ë‹ˆë‹¤.
        // nullish ë³‘í•© ì—°ì‚°ì (??)
        //  ?? ëŠ” null ë˜ëŠ” undefinedì¸ ê²½ìš°ì—ë§Œ ëŒ€ì²´ ê°’ì„ ì ìš©
        document.getElementById('pages').textContent = params.get('page') ?? 1;

        postUserInfo(params);
        postOrderInfo(params);
    });

    paging.addEventListener('change', (e)=>{
        const selectedPagingOption = e.target.value;
        console.log(selectedPagingOption);
        paging.value = selectedPagingOption;
        // sessionStorage.setItem('selectedPagingOption',selectedPagingOption);
        // URLì—ì„œ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì½ì–´ì„œ í‘œì‹œ
        const params = new URLSearchParams(window.location.search);
        if(selectedPagingOption === 'ì „ì²´ë³´ê¸°'){
            params.delete('listCount');
            params.delete('page');
        }else{
            params.set('listCount',selectedPagingOption.slice(0,2));
            params.set('page', 1);
        }
        window.location.search = params.toString();
    });
    
// ------------------------------------------------------------------------

    document.getElementById("firstPage").addEventListener("click", () => {
        const params = new URLSearchParams(window.location.search);
        if(!params.get('page') || params.get('page') == 1 ) return;

        // page íŒŒë¼ë¯¸í„°ë¥¼ ë¬´ì¡°ê±´ 1ë¡œ ì„¤ì •
        params.set("page", "1");

        window.location.search = params.toString();
    });

    document.getElementById("previousPage").addEventListener("click", () => {
        const params = new URLSearchParams(window.location.search);
        if(!params.get('page') || params.get('page') == 1 ) return;
        
        // page íŒŒë¼ë¯¸í„°ë¥¼ í˜„ì¬ í˜ì´ì§€ - 1ë¡œ ì„¤ì •
        params.set("page", +params.get('page') -1 );

        window.location.search = params.toString();
    });

    pages.addEventListener('click', (e) => {
      // a íƒœê·¸ì¸ì§€, ê·¸ë¦¬ê³  data-page ì†ì„±ì´ ìˆëŠ”ì§€ íŒë³„
      if (e.target.tagName === 'A' && e.target.dataset.page) {
        e.preventDefault(); // ê¸°ë³¸ a íƒœê·¸ ì´ë™ ë§‰ê¸°

        // í˜„ì¬ URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
        const params = new URLSearchParams(window.location.search);
        params.set('page', e.target.dataset.page); // page íŒŒë¼ë¯¸í„°ë§Œ ë³€ê²½

        window.location.search = params.toString();
      }
    });

    document.getElementById("nextPage").addEventListener("click", () => {
        const params = new URLSearchParams(window.location.search);
        if(params.get('page') == lastPageNum) return;

        
        // page íŒŒë¼ë¯¸í„°ë¥¼ í˜„ì¬ í˜ì´ì§€ +1 ë¡œ ì„¤ì •
        params.set("page", +params.get('page') +1 );
        window.location.search = params.toString();
    });

    document.getElementById("lastPage").addEventListener("click", () => {
        const params = new URLSearchParams(window.location.search);

        // page íŒŒë¼ë¯¸í„°ë¥¼ ë¬´ì¡°ê±´ ë§ˆì§€ë§‰ í˜ì´ì§€ë¡œ ì„¤ì •
        params.set("page", lastPageNum );
        window.location.search = params.toString();
    });

// ------------------------------------------------------------------------

    function postUserInfo(params) {
        const userInfoParams = new URLSearchParams({'id':params.get('id')});
        fetch(url + '/user/api/list',{ 
		    method: 'POST',
		    headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: userInfoParams.toString() 
            
		}) // ì£¼ê³  ë°›ì„ë•ŒëŠ” ë¬¸ìì—´ì„ ì£¼ê³  ë°›ëŠ”ë‹¤
            .then(response => {
                if(!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜??");
                userInfoTable.innerHTML = `<tr>
            <th><strong>íšŒì› ì •ë³´ë¥¼ í‘œì‹œí•˜ê³  ìˆìŠµë‹ˆë‹¤ ...</strong></th>
        </tr>`
                return response.json() // ë³€ìˆ˜ => ê²°ê³¼ê°’
            }) 
            .then((data) => {
                const dataset = data.data;

                if (!dataset || dataset.length === 0) {
                    userInfoTable.innerHTML = `
                        <tr>
                            <th><strong>íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</strong></th>
                        </tr>`;
                    return; // ì´í•˜ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
                }
                let html =`<tr>
                               <th>ID</th>
                               <th>Name</th>
                               <th>Gender</th>
                               <th>Age</th>
                               <th>Birthday</th>
                               <th>Address</th>
                           </tr>`;                                    
                for (const record of dataset) {
                    html += `
                    <tr>
                        <td>${record.id}</a></td>
                        <td>${record.name}</td>
                        <td>${record.gender}</td>
                        <td>${record.age}</td>
                        <td>${record.birth_date}</td>
                        <td>${record.address}</td>
                    </tr>`
                }
                userInfoTable.innerHTML = html;
                
            })
            .catch(error => { // ìœ„ì˜ then, then, ë“±ì˜ êµ¬ë¬¸ ì¤‘ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•œê±¸ error ë¼ëŠ” ë³€ìˆ˜ë¡œ ë°›ì•„ì¤Œ
                    console.error('ì˜¤ë¥˜ê°€ ë‚¬ìŒ: ', error);
            });
    }

    function postOrderInfo(params) {
        fetch(url + '/order/api/list',{ 
		    method: 'POST',
		    headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: params.toString() 
            
		}) // ì£¼ê³  ë°›ì„ë•ŒëŠ” ë¬¸ìì—´ì„ ì£¼ê³  ë°›ëŠ”ë‹¤
            .then(response => {
                if(!response.ok) throw new Error("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜??");
                orderInfoTable.innerHTML = `<tr>
            <th><strong>íšŒì› ì£¼ë¬¸ ëª©ë¡ì„ í‘œì‹œí•˜ê³  ìˆìŠµë‹ˆë‹¤ ...</strong></th>
        </tr>`
                return response.json() // ë³€ìˆ˜ => ê²°ê³¼ê°’
            }) 
            .then((data) => {
                const dataset = data.data;
                const pagingInfo = data.paging;

                dataTableDisplay(dataset);
                
                // ì—¬ê¸° ì•„ë˜ë¶€í„°ëŠ” paging
                pagesDisplay(pagingInfo);
                // `Arr.slice()`ëŠ” ê¸°ì¡´ ë°°ì—´ì„ ë³€ê²½í•˜ì§€ ì•Šê³  ìƒˆë¡œìš´ ë°°ì—´ì„ ë°˜í™˜í•˜ë©°,
                // `Arr.splice()`ëŠ” ì›ë³¸ ë°°ì—´ì„ ë³€ê²½í•˜ë©´ì„œ ìƒˆë¡œìš´ ë°°ì—´ì„ ë°˜í™˜
                
            })
            .catch(error => { // ìœ„ì˜ then, then, ë“±ì˜ êµ¬ë¬¸ ì¤‘ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí•œê±¸ error ë¼ëŠ” ë³€ìˆ˜ë¡œ ë°›ì•„ì¤Œ
                    console.error('ì˜¤ë¥˜ê°€ ë‚¬ìŒ: ', error);
            });
    }

    function pagesDisplay(pagingInfo){
        // ì—¬ê¸° ì•„ë˜ë¶€í„°ëŠ” paging
        const allCount = pagingInfo.all_count;
        const listCount = pagingInfo.list_cnt;
        const thisPage = pagingInfo.this_page;
        const allPageCount = Math.ceil(allCount / listCount);
        //pagesCount : í•˜ë‹¨ì— ë³´ì´ê³ ì‹¶ì€ í˜ì´ì§€ ìˆ˜

        //lastPageNum ê°±ì‹ 
        lastPageNum = allPageCount;

        // previousPage, nextPage
        if(thisPage==1) document.getElementById('previousPage').style.visibility ='hidden'; 
        if(thisPage == lastPageNum) document.getElementById('nextPage').style.visibility ='hidden';
        
        let pageHtml = ``;
        let pageNumArr = [];
        // í‘œì‹œí•˜ê³  ì‹¶ì€ í˜ì´ì§€ ìˆ˜ ë³´ë‹¤ ì „ì²´ í˜ì´ì§€ ìˆ˜ê°€ ì‘ì€ ê²½ìš°
        if(allPageCount <= pagesCount){
            for (let n = 1; n <= allPageCount; n++){
                if(n === thisPage)pageHtml += `<span id="thisPage">${n}</span>`;
                else pageHtml += `<span><a href="#" data-page="${n}">${n}</a></span>`;
            };
        }else{// í‘œì‹œí•˜ê³  ì‹¶ì€ í˜ì´ì§€ ìˆ˜ ë³´ë‹¤ ì „ì²´ í˜ì´ì§€ ìˆ˜ê°€ í° ê²½ìš°
            if(thisPage <= Math.ceil(pagesCount/2)){
                for (let n = 1; n <= pagesCount; n++){
                    if(n === thisPage)pageHtml += `<span id="thisPage">${n}</span>`;
                    else pageHtml += `<span><a href="#" data-page="${n}">${n}</a></span>`;
                };
            }else if(thisPage >= allPageCount - Math.ceil(pagesCount/2)){
                for (let n = allPageCount - pagesCount+1; n <= allPageCount; n++){
                    if(n === thisPage)pageHtml += `<span id="thisPage">${n}</span>`;
                    else pageHtml += `<span><a href="#" data-page="${n}">${n}</a></span>`;
                };
            }else{
                for (let n = thisPage - Math.floor(pagesCount/2); n <= thisPage + Math.floor(pagesCount/2); n++){
                    if(n === thisPage)pageHtml += `<span id="thisPage">${n}</span>`;
                    else pageHtml += `<span><a href="#" data-page="${n}">${n}</a></span>`;
                };
            }
        };
        pages.innerHTML = pageHtml;
    }

    function dataTableDisplay(dataset){
        if (!dataset || dataset.length === 0) {
            orderInfoTable.innerHTML = `
                <tr>
                    <th><strong>íšŒì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</strong></th>
                </tr>`;
            return; // ì´í•˜ ì‹¤í–‰í•˜ì§€ ì•ŠìŒ
        }
        let html =`<tr>
                       <th>í–‰ë²ˆí˜¸</th>
                       <th>Order ID</th>
                       <th>Purchased Date</th>
                       <th>Purchased Location</th>
                   </tr>`;                 
        let rowNum = 1;                     
        for (const record of dataset) {
            html += `
            <tr>
                <td> ${rowNum} </td>
                <td><a href="#">${record.order_id}</a></td>
                <td>${record.purchased_date}</td>
                <td>${record.purchased_loc}</td>
            </tr>`
            rowNum ++;
        }
        orderInfoTable.innerHTML = html;
    }

</script>
</body>
</html>